---
title: "Calculating the Smoke-free Dividend"
author: "Damon Morris"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Calculating the Smoke-free Dividend}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(smkfreediv)
library(data.table)
library(ggplot2)
library(scales)
```

## Introduction

The purpose of this vignette is to explain how to use the package `smkfreediv` package to produce estimates of 
the smoke free dividend for local authorities in England.

### Smoke free Dividend 

Chapter 7 of the Royal College of Physicians report ['Smoking and health 2021: A coming of age for tobacco control?'](https://www.rcplondon.ac.uk/projects/outputs/smoking-and-health-2021-coming-age-tobacco-control) links to evidence that 93% of spending on tobacco does not remain in the local community - it goes to manufacturers as profits or to the Treasury as tax revenue. There is therefore a potential 'dividend' to be redistributed back to local areas of 93% of the spend on tobacco if individuals switched their expenditure on tobacco to other goods.  This figure is based on [Counter arguments: how important is 
tobacco to small retailers?](http://ash.org.uk/information-and-resources/reports-submissions/reports/counter-arguments-how-important-is-tobacco-to-small-retailer) by Action on Smoking and Health (ASH)


In particular, as the areas with greater deprivation/lower incomes are also the areas with higher smoking prevalence. There is therefore an inequality dimension. Reducing smoking can therefore be interpreted as a highly targeted tax cut, benefiting the most disadvantaged communities.

## Data Sources

### Smoking Toolkit Study (STS)

Data on tobacco expenditures are obtained from the smoking toolkit study. The data contains individuals' self-reported weekly expenditure on all tobacco products. From the April 2014 wave onwards we have information on the local authority district (upper-tier) where the individual lives. In order to make local authority-level calculations we therefore use all toolkit study waves from April 2014 to February 2020, five years of data excluding the March 2020 wave which did not take place due to the coronavirus pandemic. 

This data is used to calculate for each local authority the mean weekly expenditure on tobacco by smokers, and the standard error of the mean produced to facilitate incorporating uncertainty in the mean estimates thgrough the rest of the calculation.   

### Tobacco Profiles

Data on the smoking population at local authority level is obtained from the [Public Health England (PHE) local tobacco profiles](https://fingertips.phe.org.uk/profile/tobacco-control/data#page/0) for 2019. These data are stored in the package data`smkfreediv::tobacco_profiles` and includes variables for smoking prevalence and number of smokers, their associated 
standard errors, and population size by local authority district (151 districts). 

```{r tob_profiles, echo = FALSE}
head(smkfreediv::PHE_tobacco_profiles[UTLAname %in% c("Barnsley","Sheffield","Doncaster","Rotherham"),
                                  c("UTLAname","pop_n","smk_prev","smk_prev_se","n_smokers","n_smokers_se")])
```

Data on the number of smokers by local authority is required to calculate total expenditure on tobacco by local authority, by combining this information with the mean expenditure produced using the toolkit data. The tobacco profiles include information on the local authority smoking population, smoking prevalence, and confidence intervals for smoking prevalence. 

A standard error for the number of smokers is not included in the tobacco profiles, so is obtained by calculating the total local authority population from the smoking prevalence and number of smokers figures. The smoking prevalence figure is then simulated using its point estimate and standard error and applied to the population figure to give a distribution of number of smokers from which a standard deviation can be calculated to proxy the standard error. 50,000 simulation replications are used to produce the standard deviation included with the tobacco profiles data in `smkfreediv::tobacco_profiles`. 

The plot below gives an example of the uncertainty around the smoking prevalence figures. For each of the four local authority districts in South Yorkshire, 1,000 values for smoking prevalence are drawn at random from normal distributions characterised by setting the mean equal to the point estimate for the local authority in the tobacco profiles, and the standard deviation equal to the standard error. 

The plot shows that the mean estimated smoking prevalences for Barnsley, Doncaster, and Rotherham are similar and in the range of 17.5% to 19% while for Sheffield the figure is much lower at 14%. The plot shows there is some probability of the true prevalences being closer, with the upper tail of the Sheffield distribution overlapping with the lower tails of the other distributions.

```{r s_yorks, echo = FALSE, fig.cap="Smoking Prevalence in South Yorkshire Local Authorities", fig.dim = c(6,4)}
data <- smkfreediv::PHE_tobacco_profiles[UTLAname %in% c("Barnsley","Sheffield","Doncaster","Rotherham"),
                             c("UTLAname","pop_n","smk_prev","smk_prev_se","n_smokers","n_smokers_se")]

### generate normal distributions

n_sim <- 1000
set.seed(2021)

Barnsley <- rnorm(n_sim, 
                  mean = as.numeric(data[UTLAname == "Barnsley",c("smk_prev")]) ,
                  sd =   as.numeric(data[UTLAname == "Barnsley",c("smk_prev_se")]) )

Doncaster <- rnorm(n_sim, 
                  mean = as.numeric(data[UTLAname == "Doncaster",c("smk_prev")]) ,
                  sd =   as.numeric(data[UTLAname == "Doncaster",c("smk_prev_se")]) )

Rotherham <- rnorm(n_sim, 
                   mean = as.numeric(data[UTLAname == "Rotherham",c("smk_prev")]) ,
                   sd =   as.numeric(data[UTLAname == "Rotherham",c("smk_prev_se")]) )

Sheffield <- rnorm(n_sim, 
                   mean = as.numeric(data[UTLAname == "Sheffield",c("smk_prev")]) ,
                   sd =   as.numeric(data[UTLAname == "Sheffield",c("smk_prev_se")]) )

id <- 1:n_sim

### combine into data table 

data <- cbind(id, Barnsley, Doncaster, Rotherham, Sheffield)
data <- as.data.table(data)

reshape <- melt(data, id.vars = "id", variable.name = "la", value.name = "prev")

ggplot(reshape) +
  aes(x = prev, fill = la, color = la) +
  geom_density(alpha = 0.2) +
  theme_minimal() +
  labs(y = "Density",
       x = "Smoking Prevalence (%)",
       title = "Probability Distribution of Smoking Prevalence",
       subtitle = "Sheffield is likely to have much lower prevalence than other S. Yorkshire LAs",
       color = "Local Authority",
       fill = "Local Authority") +
  theme(legend.position = "bottom") +
  scale_x_continuous(breaks = seq(10,26,1), minor_breaks = NULL)
```


### Income 

Income data is produced by the [Office for National Statistics (ONS)](https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/earningsandworkinghours/datasets/smallareaincomeestimatesformiddlelayersuperoutputareasenglandandwales). The data used is 2018 modelled average income at the medium super output area (MSOA) level, which can be matched to local authority districts. To get average income at the local authority level, a simple unweighted mean is taken across constituent MSOAs. In order to retain uncertainty information on the income figures, the MSOA level figure and confidence intervals are used to simulate the mean and standard deviation of the local authority district level income measures calculated.

We are able to produce three income measures from this data source:

1. Net annual income 
1. Net annual income equivalised using OECD equivalence scales ([see here](https://www.oecd.org/economy/growth/OECD-Note-EquivalenceScales.pdf))
1. Net annual income equivalised using OECD equivalence scales __after housing costs__

### Other 

There are other sources of data used to inform the calculation of the Upshift factor, described in more detail below. Part of the method for calculating upshift is to infer total expenditure on tobacco in the population from HMRC duty receipts for different tobacco products. This data is obtained from the ONS Tobacco Bulletin for July 2021 and stored in the package as `smkfreediv::tobacco_duty_receipts`. Data is available for calender years 1992 to 2020. 

```{r duties_tob, echo = FALSE, fig.cap="Total Duty Receipts from Tobacco Products 2000-2020", fig.dim = c(6,4) }
data <- smkfreediv::tobacco_duty_receipts[year >= 2000,]

data <- melt(data,
             id.vars = "year",
             value.name = "Duty",
             variable.name = "Product")

ggplot(data = data) +
  aes(x = year, y = Duty, color = Product) +
  geom_point() +
  geom_line() +
  geom_vline(xintercept = 2018) +
  theme_minimal() +
  labs(y = "Duty (£m)",
       x = " ") +
  scale_y_continuous(breaks = seq(0,9000,1000), labels = function(x) paste0("£",x)) +
  scale_x_continuous(breaks = seq(2000,2020,1), minor_breaks = NULL) +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45))
```

## Methods

### (i) Cleaning the Toolkit Data

This stage uses the `CleanToolkit` and `DeflateToolkit` functions. The first selects the time frame of the sample, selects and cleans variables. 

The second function is applied to the cleaned data to adjust expenditures for inflation using the tobacco component of the Consumer Price Index (CPI) so all values are expressed in December 2018 prices. Inflation data is stored in `smkfreediv::cpi_tobacco` which is [obtained from the ONS](https://www.ons.gov.uk/economy/inflationandpriceindices/timeseries/d7cb/mm23)

```{r cpi_tob, echo = FALSE, fig.cap="Tobacco Consumer Price Index (CPI) 2000-2021", fig.dim = c(6,4) }
data <- smkfreediv::cpi_tobacco

data[, date := seq(as.POSIXct("1988-01-01"), by = "month", length.out = dim(data)[1])]

data <- data[Year %in% 2000:2020,]

ggplot(data = data) + 
  aes(x = date, y = cpi) +
  geom_line() +
  labs(y = "Tobacco CPI",
       x = " ",
       caption = "Base = December 2018") +
  theme_minimal() +
  scale_x_datetime(labels = date_format("%Y-%m"), breaks = date_breaks("years")) + 
  theme(axis.text.x = element_text(angle = 45)) +
  geom_hline(yintercept = 100)
```


### (ii) Calculating the Upshift

The first step is to calculate the amount by which individual spending is upshifted. Spending is upshfifted because of discrepancy between the implied total spending by the toolkit data and the reported duty receipts by HMRC. 

The upshift factor is calculated by the `CalcUpshift` function, which is illustrated below. The amount by which expenditures need to be upshifted is determined by calculating the total expenditures on tobacco implied by (i) grossing up weekly expenditure to the population and annualising, and (ii) using data on total annual HMRC duty receipts and average prices. The upshift factor is then the ratio of the latter to the former.

#### Total Expenditure - Survey Data

First we calculate the weekly tobacco expenditure of the mean smoker in the Toolkit sample by applying the `CalcWeekSpend` function, setting the upshift factor to equal 1 (i.e. no upshifting). The mean is calculated using the sample weights and is stratified by upper tier local authority. We then merge the local authority level mean expenditures to the Public Health England tobacco profiles, multiplying mean local authority expenditure per smoker by the number of smokers in the local authority. This figure is then annualised and summed over local authorities to produce an estimate of total population expenditure on tobacco in a single year. 

```{r, include = FALSE}
tot_duty_fm  <- round(as.numeric(smkfreediv::tobacco_duty_receipts[year == 2018,"FM_cigs"]))
tot_duty_ryo <- round(as.numeric(smkfreediv::tobacco_duty_receipts[year == 2018,"RYO_tob"]))
```

#### Total Expenditure - HMRC Receipts

To calculate the expenditures from HMRC duty receipts, we obtain the duty receipts for calendar 2018 from the `smkfreediv::tobacco_duty_receipts` data described above, separately for cigarettes (£`r tot_duty_fm`m) and hand-rolled tobacco (£`r tot_duty_ryo`m). As these figures are UK totals, we adjust them to England-only totals by multiplying these totals by 82% - the proportion of smokers in the UK who live in England, calculated from the Annual Population Survey 2011-2018.

We then estimate the proportion of total price for each product which is composed of duties and combine this with the figures for total duty receipts to calculate implied total expenditure. The calculations for expenditure are based on prices for a packet of 20 cigarettes and per 100g of hand-rolled tobacco respectively. The price of hand-rolled tobacco is taken as an average of prices from various supermarkets and deflated to December 2018 prices, again using the tobacco CPI. 

Taking the price of a packet of 20 factory-made cigarettes to be £8.83, the ad-valorem tax paid per pack is £1.46 (16.5% of £8.83). With a specific duty of £228.29 per 1000 cigarettes, the duty per pack of 20 is £228.29/50 = £4.57. This means a total duty of £6.02 per pack, which is 68.21% of the price. Dividing the duty figure by this proportion gives an estimate of total expenditure on factory-made cigarettes of £9,343m. A similar calculation for RYO tobacco yields a figure of £2,425m and total tobacco expenditure of £11,768m. 

#### Upshift 

The upshift is the ratio of the two figures. The estimate from duty receipts is £11,768m of tobacco expenditure compared to £7,507m from the toolkit data. This yields an upshift of 11,768/7507 = 1.568. In calculating total expenditure by local authority in the toolkit data, all individual level expenditures are first multiplied by this upshift to correct for under-reporting of expenditures in survey data. 

Note in this example, the duty receipts estimate of total expenditure is based entirely on the HMRC duty receipts. Total expenditure must also account for spending on illicit tobacco. This is done by using the estimate of illicit spending in Howard Reeds work to construct the proportion of total expenditure which is illicit and use this to impute illicit spending from the legal spending and add this in to the total expenditure figure of £11,768m calculated above.




### (iii) Calculating the Local Authority Smoke-free Dividends

The smokefree dividend for each local authority is calculated first by obtaining the mean weekly expenditure ($\bar{e}_i$) on tobacco by smokers by local authority, with each individual expenditure multiplied by the upshift factor calculated in part (ii). Annual expenditure in local authority $i$, $E_i$, is then calculated by multiplying this upshifted weekly average by 52 and the number of smokers:

\begin{equation}
E_i = N^{smoke}_i * \bar{e}_i * 52
\end{equation}

We calculate the smokefree dividend as 93% of total local authority expenditure. A further distinction in the analysis is made between licit and illicit tobacco expenditure. We consider 100% of savings on illicit tobacco expenditure to be part of the dividend. We therefore have to identify illict expenditure from the total. To do this we use an estimate of total expenditure on illicit sources of tobacco in 2018/19 of £1,219m combined with total legal tobacco spend of £14,307. This implies, in total, a proportion of total expenditures on tobacco which are on illicit sources of approximately 8.32%. Denoting this proportion as $\rho$, we calculate the dividend, $D$, as:

\begin{equation}
D_i = (\rho * E_i) + ((1-\rho) * E_i)*0.93
\end{equation}

